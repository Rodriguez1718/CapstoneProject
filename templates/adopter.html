<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adopter Dashboard - FurEver Family</title>
    <link rel="stylesheet" href="/assets/css/adopterstyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <nav id="topbar">
        <ul class="side-bar">
            <li onclick="hideSidebar()"><a href="#">X</a></li>
            <li><a href="adopter.html">Home</a></li>
            <li><a href="#adopt">Adopt a Pet</a></li>
            <li><a href="#shelter">Shelters</a></li>
            <li><a href="#adoption">Adoption History</a></li>


            <li><a class="logout" id="logout-button" href="#" onclick="logout()">Logout</a></li>
        </ul>
        <ul>
            <li><a href="adopter.html">FurEver Family</a></li>
            <li class="hideOnMobile"><a href="#adopt">Adopt a Pet</a></li>
            <li class="hideOnMobile"><a href="#shelter">Shelters</a></li>
            <li class="hideOnMobile"><a href="#adoption">Adoption History</a></li>


            <li class="hideOnMobile"><a class="logout" id="logout-button" href="#" onclick="logout()">Logout</a></li>
            <li class="menu-button" onclick="showSidebar()"><a href="#"><i class="fas fa-bars"></i></a></li>
        </ul>
    </nav>

    <main>
        <<section id="adopt" class="spacer-adopt grid2 grid-1">
            <div><h2 class="animated-text">WELCOME ADOPTERS!!</h2></div>
            <div style="text-align: center; margin-right: auto; margin-left: auto;">
                <p class="animated-paragraph">Our adoptable cats and dogs are all spayed/neutered (kapon) and vaccinated. Because they lived a difficult life before being rescued, we need to be sure that they get adopted by loving humans and won’t be subjected to further cruelty or neglect. Here’s how to apply:</p>
            </div>
        </section>

        <section id="adopt" class="spacer grid grid-2">
            <div><h2>Available Pets for Adoption</h2></div>
            <div id="petContainer" class="pet-grid"></div>
        </section>
        <section id="shelter" class="shelter-container">
            <h2>Our Shelters</h2>
            <div id="shelterContainer" class="shelter-grid">
                <!-- Shelter cards will be dynamically loaded here -->
            </div>
        </section>
        <section id="adoption" class="adoption-history-container">
            <h2>Adoption History</h2>
            <div id="adoptionHistoryContainer" class="adoption-history-grid"></div>
        </section>
        
    </main>

    <!-- Pet Details Modal -->
    <div id="adoptModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Adopt this Pet</h2>
            <p id="petDetails"></p>
            <button id="confirmAdoptBtn">Proceed to Application</button>
        </div>
    </div>

    <!-- Application Form Modal -->
    <div id="applicationModal" class="modal">
        <div class="modal-content">
            <span class="close-app-btn">&times;</span>
            <h2>Adoption Application Form</h2>
            <form id="adoptionForm">
                <!-- Hidden field for Pet ID -->
                <input type="hidden" id="petId" name="petId">
                
                <label for="noAdoption">Number of Adoptions You Have Done:</label>
                <br>
                <input type="number" id="noAdoption" name="noAdoption" required>
                <br>

                <label for="pickupDate">Preferred Pickup Date:</label>
                <br>
                <input type="date" id="pickupDate" name="pickupDate" required>
                <br>

                <label for="adoptionIncome">Your Income:</label>
                <br>
                <input type="number" id="adoptionIncome" name="adoptionIncome" min="1" required>
                <br>

                <label for="adoptionHistory">Adoption History:</label>
                <br>
                <textarea id="adoptionHistory" name="adoptionHistory" required></textarea>
                <br>

                <label for="behavioralAssess">Behavioral Assessment:</label>
                <br>
                <textarea id="behavioralAssess" name="behavioralAssess" required></textarea>
                <br>

                <button type="submit">Submit Application</button>
            </form>
        </div>
    </div>

    

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 FurEver Family - All rights reserved.</p>
            <div class="social-links">
                <a href="https://github.com/your-github" target="_blank">
                    <i class="fab fa-github"></i>
                </a>
                <a href="https://facebook.com/your-page" target="_blank">
                    <i class="fab fa-facebook"></i>
                </a>
                <a href="https://twitter.com/your-handle" target="_blank">
                    <i class="fab fa-x-twitter"></i>
                </a>
                <a href="https://instagram.com/your-handle" target="_blank">
                    <i class="fab fa-instagram"></i>
                </a>
            </div>
        </div>
        <img src="/assets/image/dog1.jpg" alt="Happy pet owner with adopted dog">
    </footer>

    <script>


/*document.addEventListener("DOMContentLoaded", function () {
    fetch("/adoption_history_page")
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById("adoptionHistoryContainer");

            if (!data.length) {
                container.innerHTML = "<p>No adoptions found.</p>";
                return;
            }

            container.innerHTML = data.map(app => `
                <div class="history-card">
                    <img src="${app.photo_url || '/assets/default-pet.jpg'}" alt="Pet Image">
                    <h3>${app.pet_breed} (${app.pet_type})</h3>
                    <p><strong>Status:</strong> ${app.status}</p>
                    <p><strong>Pickup Date:</strong> ${app.pickup_date || "TBD"}</p>
                </div>
            `).join("");
        })
        .catch(err => {
            console.error("Failed to load adoption history:", err);
        });
});*/

document.addEventListener("DOMContentLoaded", function () {
    fetch("/get_shelters")
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById("shelterContainer");

            if (!data.length) {
                container.innerHTML = "<p>No shelters found.</p>";
                return;
            }

            container.innerHTML = data.map(shelter => `
                <div class="shelter-card">
                    <img src="${shelter.image_url}" alt="Shelter Image">
                    <h3>${shelter.shelter_name}</h3>
                    <p><strong>Address:</strong> ${shelter.address}</p>
                    <p><strong>Contact:</strong> ${shelter.contact_number}</p>
                    <p><strong>Email:</strong> <a href="mailto:${shelter.email}">${shelter.email}</a></p>
                </div>
            `).join("");
        })
        .catch(err => {
            console.error("Failed to load shelters:", err);
        });
});
function fetchReviews(shelterId) {
    fetch(`/get_reviews/${shelterId}`)
        .then(response => response.json())
        .then(data => {
            const reviewContainer = document.getElementById(`reviewContainer-${shelterId}`);
            if (!data.length) {
                reviewContainer.innerHTML = "<p>No reviews yet.</p>";
                return;
            }

            reviewContainer.innerHTML = data.map(review => `
                <div class="review-card">
                    <p><strong>${review.user_name}</strong> (${review.rating} ★)</p>
                    <p>${review.review}</p>
                </div>
            `).join("");
        })
        .catch(error => {
            console.error(`Error fetching reviews for shelter ${shelterId}:`, error);
        });
}

// Function to submit a review for a specific shelter
function submitReview(event, shelterId) {
    event.preventDefault();

    const rating = document.getElementById(`rating-${shelterId}`).value;
    const review = document.getElementById(`review-${shelterId}`).value;

    fetch("/submit_review", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ shelter_id: shelterId, rating: rating, review: review })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            fetchReviews(shelterId); // Refresh reviews
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error("Error submitting review:", error);
        alert("An error occurred while submitting your review.");
    });
}

document.addEventListener("DOMContentLoaded", function () {
    fetch("/get_shelters")
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById("shelterContainer");

            if (!data.length) {
                container.innerHTML = "<p>No shelters found.</p>";
                return;
            }

            container.innerHTML = data.map(shelter => `
                <div class="shelter-card">
                    <img src="${shelter.image_url}" alt="Shelter Image">
                    <h3>${shelter.shelter_name}</h3>
                    <p><strong>Address:</strong> ${shelter.address}</p>
                    <p><strong>Contact:</strong> ${shelter.contact_number}</p>
                    <p><strong>Email:</strong> <a href="mailto:${shelter.email}">${shelter.email}</a></p>
                    
                    <!-- Reviews Section -->
                    <div class="review-section" id="reviewSection-${shelter.shelter_id}">
                        <h4>Reviews</h4>
                        <div class="review-container" id="reviewContainer-${shelter.shelter_id}">
                            <!-- Reviews will be dynamically loaded here -->
                        </div>
                        <h4>Leave a Review</h4>
                        <form class="review-form" onsubmit="submitReview(event, ${shelter.shelter_id})">
                            <label for="rating-${shelter.shelter_id}">Rating:</label>
                            <select id="rating-${shelter.shelter_id}" name="rating" required>
                                <option value="5">★★★★★</option>
                                <option value="4">★★★★☆</option>
                                <option value="3">★★★☆☆</option>
                                <option value="2">★★☆☆☆</option>
                                <option value="1">★☆☆☆☆</option>
                            </select>
                            <br>
                            <label for="review-${shelter.shelter_id}">Review:</label>
                            <textarea id="review-${shelter.shelter_id}" name="review" required></textarea>
                            <br>
                            <button type="submit">Submit Review</button>
                        </form>
                    </div>
                </div>
            `).join("");

            // Fetch reviews for each shelter
            data.forEach(shelter => fetchReviews(shelter.shelter_id));
        })
        .catch(err => {
            console.error("Failed to load shelters:", err);
        });
});

        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                fetch('/logout', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (response.ok) {
                        alert("Logged out successfully!");
                        localStorage.removeItem("isLoggedIn");
                        localStorage.removeItem("role");
                        window.location.href = "/loginAdmin";
                    } else {
                        alert("Logout failed. Please try again.");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("An error occurred. Please try again.");
                });
            }
        }


        document.getElementById("confirmAdoptBtn").addEventListener("click", function () {
    console.log("Proceed to Application button clicked"); // Debugging
    openApplicationModal();
});
        function fetchPets() {
    fetch("/get_pets")
        .then(response => response.json())
        .then(data => {
            const petContainer = document.getElementById("petContainer");
            petContainer.innerHTML = data
                .filter(pet => pet.evaluation_status !== "Approved")  // Ensure adopted pets are not shown
                .map(pet => `
                    <div class="pet-card">
                        <img src="${pet.photo_url || '/assets/default-pet.jpg'}" alt="Pet Image">
                        <h3>${encodeHTML(pet.pet_breed) || "Unnamed Pet"}</h3>
                        <p><strong>Height(cm):</strong> ${pet.pet_height || "Unknown"}</p>
                        <p><strong>Weight(kg):</strong> ${pet.pet_weight || "Unknown"}</p>
                        <p><strong>Shelter:</strong> ${pet.shelter_name || "Not specified"}</p>
                        <p><strong>Available:</strong> ${pet.quantity || "Not Available"}</p>
                        <button class="adopt-btn">Adopt</button>
                    </div>
                `).join("");

            const adoptButtons = document.querySelectorAll(".adopt-btn");
            adoptButtons.forEach((button, index) => {
                button.addEventListener("click", () => openAdoptModal(data[index]));
            });
        })
        .catch(error => console.error("Error fetching pets:", error));
}
        function encodeHTML(str) {
            return str ? str.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";
        }

        let currentPet = null;

        function openAdoptModal(pet) {
        currentPet = pet;
        const petDetails = document.getElementById('petDetails');
        petDetails.innerHTML = `
        <strong>Breed:</strong> ${encodeHTML(pet.pet_breed)}<br>
        <strong>Height:</strong> ${pet.pet_height || "Unknown"}<br>
        <strong>Weight:</strong> ${pet.pet_weight || "Unknown"}<br>
        <strong>Shelter:</strong> ${pet.shelter_name || "Not specified"}<br>
        <strong>Available:</strong> ${pet.quantity || "Not Available"}<br>
    `;
    document.getElementById('petId').value = pet.pet_id; // Set pet ID in the form
    document.getElementById('adoptModal').style.display = "block";
}

document.addEventListener("DOMContentLoaded", function () {
    fetch("/adoption_history_data")
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById("adoptionHistoryContainer");

            if (!data.length) {
                container.innerHTML = "<p>No adoptions found.</p>";
                return;
            }

            container.innerHTML = data.map(app => `
                <div class="history-card">
                    <img src="${app.photo_url}" alt="Pet Image">
                    <h3>${app.pet_breed} (${app.pet_type})</h3>
                    <p><strong>Status:</strong> ${app.status}</p>
                    <p><strong>Pickup Date:</strong> ${app.pickup_date}</p>
                </div>
            `).join("");
        })
        .catch(err => {
            console.error("Failed to load adoption history:", err);
        });
});
        function closeAdoptModal() {
            document.getElementById('adoptModal').style.display = "none";
        }

        function openApplicationModal() {
    console.log("Opening application modal"); // Debugging
    document.getElementById('applicationModal').style.display = 'block';
}

        function closeApplicationModal() {
            document.getElementById('applicationModal').style.display = 'none';
        }

        document.querySelector('.close-btn').addEventListener('click', closeAdoptModal);
        document.querySelector('.close-app-btn').addEventListener('click', closeApplicationModal);

        window.addEventListener('click', function(event) {
            const modal1 = document.getElementById('adoptModal');
            const modal2 = document.getElementById('applicationModal');
            if (event.target === modal1) closeAdoptModal();
            if (event.target === modal2) closeApplicationModal();
        });

        document.getElementById('adoptionForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const submitButton = event.target.querySelector('button[type="submit"]');
    submitButton.disabled = true;  // Disable submit button to prevent double submission

    const petId = document.getElementById('petId').value;
    const noAdoption = document.getElementById('noAdoption').value;
    const pickupDate = document.getElementById('pickupDate').value;
    const adoptionIncome = document.getElementById('adoptionIncome').value;
    const adoptionHistory = document.getElementById('adoptionHistory').value;
    const behavioralAssess = document.getElementById('behavioralAssess').value;

    const applicationData = {
        pet_id: petId,
        no_adoption: noAdoption,
        pickup_date: pickupDate,
        adoption_income: adoptionIncome,
        adoption_history: adoptionHistory,
        behavioral_assess: behavioralAssess
    };

    fetch("/application", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(applicationData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            closeApplicationModal();
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error("Error submitting application:", error);
        alert("An error occurred while submitting your application.");
    })
    .finally(() => {
        submitButton.disabled = false;  // Re-enable submit button
    });
});
        document.addEventListener("DOMContentLoaded", fetchPets);
    </script>
</body>
</html>
